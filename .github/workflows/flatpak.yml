name: Flatpak

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: freedesktopsdk/flatpak:20.08-x86_64
      options: --privileged --tmpfs /tmp -v /var/tmp -v /root/.local/share/flatpak

    steps:
      - uses: actions/checkout@v2

      - name: Prime cache
        uses: actions/cache@v2
        with:
          path: |
            .flatpak-builder/ccache
          key: flatpak-builder-${{ github.run_id }}
          restore-keys: |
            flatpak-builder-

      - name: Build flatpak
        uses: gasinvein/action-flatpak-build@master
        id: build_flatpak
        with:
          kind: app
          id: org.winehq.Wine
          arch: x86_64
          branch: master

      - name: Upload build repo
        uses: actions/upload-artifact@v2
        with:
          name: wine-build-repo
          path: ${{ steps.build_flatpak.outputs.build-repo }}

  publish-ostree:
    if: github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    needs: build
    container:
      image: freedesktopsdk/flatpak:20.08-x86_64
      options: --privileged --tmpfs /tmp -v /var/tmp -v /root/.local/share/flatpak

    steps:
      - uses: actions/checkout@v2

      - name: Download build repo
        uses: actions/download-artifact@v2
        with:
          name: wine-build-repo
          path: wine-build-repo

      #TODO: move this to flatpak-upload action
      - name: Repait OSTree repo
        run: |
          mkdir -p wine-build-repo/{extensions,refs/{mirrors,remotes},state,tmp/cache}

      - name: Publish to OSTree repo
        uses: vrutkovs/action-flatpak-upload@main
        with:
          build-repo-path: wine-build-repo
          url: https://flatpak.russianfedora.online/repo
          name: stable
          token: ${{ secrets.FLATPAK_REPO_TOKEN }}
